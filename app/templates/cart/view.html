{% extends "base.html" %}

{% block title %}购物车 - 美团外卖{% endblock %}

{% block content %}
<div class="cart-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="cart-header">
                    <h2><i class="fas fa-shopping-cart me-2"></i>购物车</h2>
                </div>
            </div>
        </div>

        {% if restaurants_cart %}
            <div class="row">
                <div class="col-lg-8">
                                    <!-- 购物车商品列表 -->
                {% for restaurant_id, cart_data in restaurants_cart.items() if restaurants_cart %}
                    <div class="restaurant-cart-section mb-4">
                        <div class="restaurant-header">
                            <h4>
                                <i class="fas fa-store me-2"></i>
                                {{ cart_data.restaurant.name }}
                            </h4>
                            <span class="delivery-info">
                                {% if cart_data.restaurant.delivery_fee == 0 %}
                                    <span class="text-success">免配送费</span>
                                {% else %}
                                    配送费 ¥{{ cart_data.restaurant.delivery_fee }}
                                {% endif %}
                                | 起送 ¥{{ cart_data.restaurant.min_order }}
                            </span>
                        </div>

                        <div class="cart-items">
                            {% for item in cart_data['items'] %}
                            <div class="cart-item" data-item-id="{{ item.cart_item.id }}">
                                <div class="item-image">
                                    <img src="{{ item.dish.image or '/static/images/dishes/default.jpg' }}" 
                                         alt="{{ item.dish.name }}">
                                </div>
                                <div class="item-info">
                                    <h5 class="item-name">{{ item.dish.name }}</h5>
                                    <p class="item-desc">{{ item.dish.description }}</p>
                                    <div class="item-price">
                                        {% if item.dish.original_price %}
                                            <span class="original-price">¥{{ item.dish.original_price }}</span>
                                        {% endif %}
                                        <span class="current-price">¥{{ item.dish.price }}</span>
                                    </div>
                                </div>
                                <div class="item-controls">
                                    <div class="quantity-controls">
                                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                                data-cart-id="{{ item.cart_item.id }}" data-action="decrease">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="quantity">{{ item.cart_item.quantity }}</span>
                                        <button class="btn btn-sm btn-outline-secondary quantity-btn" 
                                                data-cart-id="{{ item.cart_item.id }}" data-action="increase">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="item-total">
                                        ¥<span class="total-price">{{ item.total }}</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            data-cart-id="{{ item.cart_item.id }}" data-action="remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="restaurant-subtotal">
                            <strong>小计：¥{{ cart_data.subtotal }}</strong>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="col-lg-4">
                    <!-- 订单摘要 -->
                    <div class="order-summary">
                        <h4>订单摘要</h4>
                        
                        <!-- 地址选择 -->
                        <div class="address-section mb-3">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>收货地址</h6>
                            {% if addresses %}
                                <form id="checkout-form" method="POST" action="{{ url_for('cart.checkout') }}">
                                    <div class="address-list">
                                        {% for address in addresses %}
                                        <div class="form-check address-item">
                                            <input class="form-check-input" type="radio" 
                                                   name="address_id" value="{{ address.id }}" 
                                                   id="address{{ address.id }}"
                                                   {% if address.is_default %}checked{% endif %}>
                                            <label class="form-check-label" for="address{{ address.id }}">
                                                <strong>{{ address.name }}</strong> {{ address.phone }}<br>
                                                <small class="text-muted">{{ address.address }}</small>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="remark" class="form-label">备注</label>
                                        <textarea class="form-control" id="remark" name="remark" 
                                                  rows="2" placeholder="给商家的备注信息"></textarea>
                                    </div>
                                </form>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    请先添加收货地址
                                    <a href="{{ url_for('auth.profile') }}" class="btn btn-sm btn-warning ms-2">
                                        添加地址
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                        <!-- 价格明细 -->
                        <div class="price-details">
                            <div class="price-row">
                                <span>商品总价</span>
                                <span>¥{{ total_amount }}</span>
                            </div>
                            {% for restaurant_id, cart_data in restaurants_cart.items() %}
                                {% if cart_data.restaurant.delivery_fee > 0 %}
                                <div class="price-row">
                                    <span>{{ cart_data.restaurant.name }} 配送费</span>
                                    <span>¥{{ cart_data.restaurant.delivery_fee }}</span>
                                </div>
                                {% endif %}
                            {% endfor %}
                            <hr>
                            <div class="price-row total-row">
                                <strong>
                                    <span>总计</span>
                                    <span>¥<span id="final-total">{{ final_total }}</span></span>
                                </strong>
                            </div>
                        </div>

                        <!-- 结算按钮 -->
                        <div class="checkout-section">
                            {% if addresses %}
                                <button type="submit" form="checkout-form" class="btn btn-warning btn-lg w-100">
                                    <i class="fas fa-credit-card me-2"></i>去结算
                                </button>
                            {% else %}
                                <button class="btn btn-secondary btn-lg w-100" disabled>
                                    请先添加收货地址
                                </button>
                            {% endif %}
                        </div>

                        <!-- 其他操作 -->
                        <div class="cart-actions mt-3">
                            <a href="{{ url_for('restaurant.list_restaurants') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-arrow-left me-2"></i>继续购物
                            </a>
                            <button onclick="clearCart()" class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash me-2"></i>清空购物车
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- 空购物车 -->
            <div class="empty-cart">
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                    <h3 class="text-muted">购物车是空的</h3>
                    <p class="text-muted">快去选择您喜欢的美食吧！</p>
                    <a href="{{ url_for('restaurant.list_restaurants') }}" class="btn btn-warning btn-lg">
                        <i class="fas fa-utensils me-2"></i>去点餐
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.cart-container {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.cart-header {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.restaurant-cart-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.restaurant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
}

.restaurant-header h4 {
    margin: 0;
    color: #333;
}

.delivery-info {
    font-size: 14px;
    color: #666;
}

.cart-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.cart-item:last-child {
    border-bottom: none;
}

.item-image {
    width: 80px;
    height: 80px;
    margin-right: 15px;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.item-info {
    flex: 1;
    margin-right: 15px;
}

.item-name {
    font-size: 16px;
    font-weight: bold;
    margin: 0 0 5px 0;
    color: #333;
}

.item-desc {
    font-size: 14px;
    color: #666;
    margin: 0 0 8px 0;
}

.item-price .original-price {
    text-decoration: line-through;
    color: #999;
    margin-right: 8px;
}

.item-price .current-price {
    color: #ff6b35;
    font-weight: bold;
}

.item-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quantity-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quantity {
    min-width: 30px;
    text-align: center;
    font-weight: bold;
}

.item-total {
    font-weight: bold;
    color: #ff6b35;
}

.restaurant-subtotal {
    text-align: right;
    padding-top: 15px;
    border-top: 1px solid #eee;
    font-size: 18px;
    color: #ff6b35;
}

.order-summary {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
}

.order-summary h4 {
    margin-bottom: 20px;
    color: #333;
}

.address-item {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.address-item:hover {
    border-color: #ffd900;
    background-color: #fff8e1;
}

.address-item input:checked + label {
    color: #333;
}

.price-details {
    margin: 20px 0;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.total-row {
    font-size: 18px;
    color: #ff6b35;
}

.empty-cart {
    background: white;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .cart-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .item-controls {
        flex-direction: row;
        width: 100%;
        justify-content: space-between;
    }
    
    .restaurant-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 处理数量按钮点击
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const cartId = this.dataset.cartId;
            const action = this.dataset.action;
            const quantitySpan = this.parentElement.querySelector('.quantity');
            const currentQuantity = parseInt(quantitySpan.textContent);
            
            if (action === 'increase') {
                updateQuantity(cartId, currentQuantity + 1);
            } else if (action === 'decrease') {
                updateQuantity(cartId, currentQuantity - 1);
            }
        });
    });
    
    // 处理删除按钮点击
    document.querySelectorAll('[data-action="remove"]').forEach(button => {
        button.addEventListener('click', function() {
            const cartId = this.dataset.cartId;
            removeItem(cartId);
        });
    });
});

function updateQuantity(cartItemId, newQuantity) {
    if (newQuantity < 1) {
        removeItem(cartItemId);
        return;
    }
    
    fetch('/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            cart_item_id: cartItemId,
            quantity: newQuantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '更新失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请重试');
    });
}

function removeItem(cartItemId) {
    if (!confirm('确定要移除这个商品吗？')) {
        return;
    }
    
    fetch('/cart/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            cart_item_id: cartItemId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '删除失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请重试');
    });
}

function clearCart() {
    if (!confirm('确定要清空购物车吗？')) {
        return;
    }
    
    window.location.href = '/cart/clear';
}
</script>
{% endblock %} 